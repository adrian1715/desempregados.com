<%- layout('../layouts/boilerplate') %>

<main class="container py-5">
  <%- include('../../partials/flash') %>

  <div class="d-flex justify-content-between align-items-center mb-3">
    <h1 class="d-inline-block">Vagas</h1>
    <a href="/vagas/adicionar" class="btn btn-success ms-2">
      <i class="bi bi-patch-plus me-2"></i>Nova vaga*
    </a>
  </div>

  <!-- Filter Toggle Button -->
  <div class="mb-3">
    <button class="btn btn-outline-primary" type="button" data-bs-toggle="collapse" data-bs-target="#filterCollapse" aria-expanded="false" aria-controls="filterCollapse">
      <i class="bi bi-funnel me-2"></i>Filtrar
      <i class="bi bi-chevron-down ms-1" id="filter-chevron"></i>
    </button>
  </div>

  <!-- Filter Controls -->
  <div class="collapse mb-4" id="filterCollapse">
    <div class="card">
      <div class="card-body">
        <div class="row g-3">
        <!-- Search -->
        <div class="col-md-6 col-lg-4">
          <label for="filter-search" class="form-label">
            <i class="bi bi-search me-1"></i>Pesquisar
          </label>
          <input type="text" id="filter-search" class="form-control" placeholder="Título ou descrição...">
        </div>

        <!-- Career Filter -->
        <div class="col-md-6 col-lg-3">
          <label for="filter-career" class="form-label">
            <i class="bi bi-briefcase me-1"></i>Carreira
          </label>
          <select id="filter-career" class="form-select">
            <option value="">Todas</option>
            <% if (Array.isArray(careers)) { %> <% careers.forEach((career) => { %>
              <option value="<%= career.name %>"><%= career.name %></option>
            <% }) %> <% } %>
          </select>
        </div>

        <!-- Company Filter -->
        <div class="col-md-6 col-lg-3">
          <label for="filter-company" class="form-label">
            <i class="bi bi-building me-1"></i>Empresa
          </label>
          <select id="filter-company" class="form-select">
            <option value="">Todas</option>
            <%
              // Get unique companies
              const uniqueCompanies = {};
              jobs.forEach((job, idx) => {
                if (companies[idx] && companies[idx]._id && companies[idx].name) {
                  uniqueCompanies[companies[idx]._id] = companies[idx].name;
                }
              });
            %>
            <% Object.entries(uniqueCompanies).forEach(([id, name]) => { %>
              <option value="<%= id %>"><%= name %></option>
            <% }) %>
          </select>
        </div>

        <!-- Date Sort -->
        <div class="col-md-6 col-lg-2">
          <label for="filter-date" class="form-label">
            <i class="bi bi-calendar me-1"></i>Data
          </label>
          <select id="filter-date" class="form-select">
            <option value="">Todas</option>
            <option value="newest">Mais recentes</option>
            <option value="oldest">Mais antigas</option>
            <option value="7">Últimos 7 dias</option>
            <option value="30">Últimos 30 dias</option>
          </select>
        </div>
      </div>

        <!-- Action Buttons -->
        <div class="d-flex gap-2 mt-3">
          <button id="btn-apply-filters" class="btn btn-primary">
            <i class="bi bi-funnel me-1"></i>Aplicar Filtros
          </button>
          <button id="btn-clear-filters" class="btn btn-outline-secondary">
            <i class="bi bi-x-circle me-1"></i>Limpar
          </button>
        </div>
      </div>
    </div>
  </div>

  <% 
    // small helper to map internal type to user-friendly portuguese
    function jobTypeLabel(t) {
      const map = {
        "full-time":"Tempo integral",
        "part-time":"Meio período",
        "contract":"Contrato",
        "internship":"Estágio",
        "temporary":"Temporário"
      };
      return map[t] || (t ? t : "—");
    }

    // helper to decide remote truthiness (handles 'on','true',boolean)
    function isRemoteFlag(v){
      return v === true || v === 'true' || v === 'on' || v === 'yes';
    }
  %>

  <% if (!Array.isArray(jobs) || jobs.length === 0) { %>
    <div class="alert alert-info">Nenhuma vaga cadastrada.</div>
  <% } else { %>
    <div id="jobs-grid" class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-3">
      <% jobs.forEach((job, i) => {
        const titleDesc = ((job.title || '') + ' ' + (job.description || '')).toLowerCase();
        const companyId = companies[i] && companies[i]._id ? companies[i]._id : '';
      %>
        <div class="col job-card"
             data-position-id="<%= job.position || '' %>"
             data-company-id="<%= companyId %>"
             data-created-at="<%= job.createdAt || '' %>"
             data-title-desc="<%= titleDesc.replace(/"/g, '&quot;') %>">
          <div class="card h-100 shadow-sm">
            <div class="card-body d-flex flex-column">
              <h5 class="card-title mb-1"><%= truncateToLastWord(job.title || '—', 50) %></h5>

              <h6 class="card-subtitle text-muted mb-2">
                <%= job.position ? companies[i].name :  '—' %>
              </h6>

              <p class="card-text text-muted mb-2" style="max-height:3.6em; overflow:hidden;" title="<%= job.description ? job.description.replace(/"/g,'&quot;') : '' %>">
                <%= job.description ? truncateToLastWord(job.description, 100) : 'Sem descrição.' %>
              </p>

              <div class="mt-auto">
                <div class="d-flex flex-wrap justify-content-between gap-2 mb-2">
                  <div class="d-flex gap-2 flex-wrap">
                    <% if (job.salary) { %>
                      <span class="badge bg-info text-dark">R$ <%= job.salary %></span>
                    <% } else { %>
                      <span class="badge bg-secondary">Salário não informado</span>
                    <% } %>

                    <span class="badge bg-secondary"><i class="bi bi-calendar-event me-1"></i><%= jobTypeLabel(job.type) %></span>

                    <% if (isRemoteFlag(job.isRemote)) { %>
                      <span class="badge bg-success"><i class="bi bi-house-door me-1"></i>Remoto</span>
                    <% } %>

                    <% if (job.location && (job.location.city || job.location.state)) { %>
                      <span class="badge bg-info text-dark">
                        <i class="bi bi-geo-alt me-1"></i>
                        <%= job.location.city || '' %><% if (job.location.city && job.location.state) { %>, <% } %><%= formatState ? formatState(job.location.state, 1) : (job.location.state || '') %>
                      </span>
                    <% } %>
                  </div>

                  <span class="badge bg-primary"><i class="bi bi-people me-1"></i><%= (job.applicants && job.applicants.length) || (job.applied && job.applied.length) || 0 %> candidatos</span>
                </div>

                <div class="d-flex justify-content-between align-items-center">
                  <a href="/vagas/<%= job._id %>" class="btn btn-sm btn-outline-primary"><i class="bi bi-briefcase me-1"></i>Ver vaga</a>
                  <small class="text-muted"><%= job.createdAt ? new Date(job.createdAt).toLocaleDateString('pt-BR') : '' %></small>
                </div>
              </div>
            </div>
          </div>
        </div>
      <% }) %>
    </div>
  <% } %>

</main>
